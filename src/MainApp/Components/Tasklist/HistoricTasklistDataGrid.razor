@using Camunda.Http.Api.Model
@using Camunda.Http.Api

<DataGrid TItem="HistoricTaskInstanceDto"
          Data="@userTasks"
          ReadData="@OnReadData"
          RowSelectable="dto => false "
          ShowPager="true"
          TotalItems="@totalUserTasks"
          PageSize="@PageSize" >
    <EmptyTemplate>
        <div class="box">
            No variable instances found!
        </div>
    </EmptyTemplate>

    <LoadingTemplate>
        <div class="box">
            Loading...
        </div>
    </LoadingTemplate>
    <ChildContent>
        <DataGridColumn TItem="HistoricTaskInstanceDto" Field="@nameof(HistoricTaskInstanceDto.Name)" Caption="Title"/>
        <DataGridColumn TItem="HistoricTaskInstanceDto" Field="@nameof(HistoricTaskInstanceDto.Assignee)" Caption="Assignee"/>
        <DataGridColumn TItem="HistoricTaskInstanceDto" Field="@nameof(HistoricTaskInstanceDto.TenantId)" Caption="Tenant"/>
        <DataGridColumn TItem="HistoricTaskInstanceDto" Field="@nameof(HistoricTaskInstanceDto.StartTime)" Caption="Created At"/>
        <DataGridColumn TItem="HistoricTaskInstanceDto" Field="@nameof(HistoricTaskInstanceDto.EndTime)" Caption="Completed At"/>
    </ChildContent>
    <DetailRowTemplate>
                   <Card>
                       <CardBody>
                           <Container>
                               <Row>
                                   <Column><Paragraph>Assignee @context.Assignee</Paragraph></Column>
                                   <Column><Paragraph>StartTime @context.StartTime</Paragraph></Column>
                                   <Column><Paragraph>EndTime @context.EndTime</Paragraph></Column>
                               </Row>
                               <Row>
                                   <Column><Paragraph>Name @context.Name</Paragraph></Column>
                                   <Column> <Paragraph>Due Date @context.Due</Paragraph></Column>
                                   <Column><Paragraph>Tenant @context.TenantId</Paragraph></Column>
                               </Row>
                               <Row>
                                   <Paragraph>Task Description @context.Description</Paragraph>
                               </Row>
                           </Container>

                       </CardBody>
                        </Card>
    </DetailRowTemplate>
</DataGrid>


@code {

    [Parameter]
    public CamundaClient Camunda { get; set; }

    [Parameter]
    public int PageSize { get; set; } = 25;
    
    
    private List<HistoricTaskInstanceDto> userTasks;
    private int totalUserTasks;

    

    async Task OnReadData(DataGridReadDataEventArgs<HistoricTaskInstanceDto> e)
    {
        var query = new HistoricTaskInstanceQueryDto()
        {
            Sorting = new List<HistoricTaskInstanceQueryDtoSorting>()
            {
                new()
                {
                    SortBy = HistoricTaskInstanceQueryDtoSorting.SortByEnum.StartTime,
                    SortOrder = HistoricTaskInstanceQueryDtoSorting.SortOrderEnum.Desc
                }
            }
        };

        var totalQuery = new HistoricTaskInstanceQueryDto()
        {
        };

        userTasks = await Camunda.Api.HistoricTaskInstanceApi.QueryHistoricTaskInstancesAsync(e.PageSize * (e.Page - 1), e.PageSize, query);

        totalUserTasks = Convert.ToInt32((await Camunda.Api.HistoricTaskInstanceApi.QueryHistoricTaskInstancesCountAsync(totalQuery)).Count);

        StateHasChanged();
    }

}